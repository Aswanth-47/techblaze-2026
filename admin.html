<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin â€” Tech Blaze 3.0</title>
  <link rel="stylesheet" href="style.css">
  <style>
    * { box-sizing: border-box; }
    .admin-wrap { max-width:1400px; margin:0 auto; padding:28px 24px 60px; position:relative; z-index:5; }
    .admin-topbar { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:32px; }
    .admin-brand { display:flex; align-items:center; gap:12px; }
    .admin-logo { width:40px; height:40px; background:linear-gradient(135deg,#6c63ff,#a78bfa); border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:14px; color:#fff; }
    .admin-title { font-size:18px; font-weight:700; color:#fff; }
    .admin-sub { font-size:12px; color:rgba(255,255,255,0.4); }
    .admin-actions { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .export-group { display:flex; gap:8px; align-items:center; }
    .export-label { font-size:11px; color:rgba(255,255,255,0.3); text-transform:uppercase; letter-spacing:0.07em; }
    .btn-export-csv { display:inline-flex; align-items:center; gap:6px; padding:9px 16px; background:rgba(102,187,106,0.15); border:1px solid rgba(102,187,106,0.3); color:#66bb6a; border-radius:10px; font-size:13px; font-weight:600; text-decoration:none; cursor:pointer; transition:background .2s; }
    .btn-export-csv:hover { background:rgba(102,187,106,0.28); }
    .btn-export-xlsx { display:inline-flex; align-items:center; gap:6px; padding:9px 16px; background:rgba(33,150,83,0.15); border:1px solid rgba(33,150,83,0.35); color:#2ecc71; border-radius:10px; font-size:13px; font-weight:600; text-decoration:none; cursor:pointer; transition:background .2s; }
    .btn-export-xlsx:hover { background:rgba(33,150,83,0.28); }
    .btn-export-docx { display:inline-flex; align-items:center; gap:6px; padding:9px 16px; background:rgba(41,128,185,0.15); border:1px solid rgba(41,128,185,0.35); color:#5dade2; border-radius:10px; font-size:13px; font-weight:600; text-decoration:none; cursor:pointer; transition:background .2s; }
    .btn-export-docx:hover { background:rgba(41,128,185,0.28); }
    .btn-logout { display:inline-flex; align-items:center; gap:6px; padding:9px 16px; background:rgba(239,83,80,0.12); border:1px solid rgba(239,83,80,0.25); color:#ef5350; border-radius:10px; font-size:13px; font-weight:600; cursor:pointer; transition:background .2s; }
    .btn-logout:hover { background:rgba(239,83,80,0.22); }
    .stats-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:14px; margin-bottom:28px; }
    .stat-card { background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:14px; padding:18px 20px; }
    .stat-card-label { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.08em; color:rgba(255,255,255,0.35); margin-bottom:6px; }
    .stat-card-value { font-size:28px; font-weight:800; color:#fff; line-height:1; }
    .stat-card-value.green { color:#66bb6a; }
    .stat-card-value.blue  { color:#42a5f5; }
    .stat-card-value.orange{ color:#ffa726; }
    .stat-card-value.purple{ color:#ab47bc; }
    .search-bar { display:flex; gap:10px; margin-bottom:20px; }
    .search-bar input { flex:1; padding:10px 16px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); border-radius:10px; color:#fff; font-size:14px; font-family:inherit; outline:none; }
    .search-bar input:focus { border-color:#6c63ff; }
    .search-bar button { padding:10px 18px; background:#6c63ff; color:#fff; border:none; border-radius:10px; font-size:13px; font-weight:600; cursor:pointer; font-family:inherit; }
    .search-bar .btn-clear { padding:10px 14px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); color:rgba(255,255,255,0.5); border-radius:10px; cursor:pointer; font-size:13px; }
    .table-wrap { overflow-x:auto; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08); border-radius:16px; }
    table { width:100%; border-collapse:collapse; min-width:900px; }
    thead th { padding:13px 16px; text-align:left; font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:0.07em; color:rgba(255,255,255,0.35); border-bottom:1px solid rgba(255,255,255,0.07); white-space:nowrap; }
    tbody td { padding:13px 16px; font-size:13px; color:rgba(255,255,255,0.8); border-bottom:1px solid rgba(255,255,255,0.05); vertical-align:top; }
    tbody tr:last-child td { border-bottom:none; }
    tbody tr:hover td { background:rgba(255,255,255,0.03); }
    .ref-badge { display:inline-block; padding:3px 10px; background:rgba(108,99,255,0.2); border:1px solid rgba(108,99,255,0.35); color:#a78bfa; border-radius:6px; font-size:12px; font-weight:600; white-space:nowrap; }
    .team-name { font-weight:600; color:#fff; }
    .member-chip { display:inline-block; background:rgba(255,255,255,0.07); border-radius:5px; padding:1px 7px; font-size:12px; margin-bottom:2px; }
    .food-veg { color:#66bb6a; }
    .food-nonveg { color:#ffa726; }
    .no-results { text-align:center; padding:50px 20px; color:rgba(255,255,255,0.3); font-size:15px; }
    .loading { text-align:center; padding:50px; color:rgba(255,255,255,0.4); }
    .count-info { text-align:right; margin-top:12px; font-size:12px; color:rgba(255,255,255,0.3); }
  </style>
</head>
<body>
  <div class="orb orb-1"></div>
  <div class="orb orb-2"></div>

  <div class="admin-wrap">
    <!-- Top Bar -->
    <div class="admin-topbar">
      <div class="admin-brand">
        <div class="admin-logo">CT</div>
        <div>
          <div class="admin-title">Admin Panel</div>
          <div class="admin-sub">Tech Blaze 3.0 â€” Registrations</div>
        </div>
      </div>
      <div class="admin-actions">
        <div class="export-group">
          <span class="export-label">Export:</span>
          <button class="btn-export-csv" onclick="doExport('csv')">ðŸ“„ CSV</button>
          <button class="btn-export-xlsx" onclick="doExport('xlsx')">ðŸŸ¢ Excel</button>
          <button class="btn-export-docx" onclick="doExport('docx')">ðŸ”µ Word</button>
        </div>
        <button class="btn-logout" onclick="logout()">âŽ‹ Logout</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card"><div class="stat-card-label">Total Teams</div><div class="stat-card-value blue" id="statTeams">â€”</div></div>
      <div class="stat-card"><div class="stat-card-label">Total Participants</div><div class="stat-card-value purple" id="statMembers">â€”</div></div>
      <div class="stat-card"><div class="stat-card-label">Vegetarian</div><div class="stat-card-value green" id="statVeg">â€”</div></div>
      <div class="stat-card"><div class="stat-card-label">Non-Vegetarian</div><div class="stat-card-value orange" id="statNonveg">â€”</div></div>
    </div>

    <!-- Search -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by team name, college, leader name, or ref IDâ€¦" onkeydown="if(event.key==='Enter') doSearch()">
      <button onclick="doSearch()">Search</button>
      <button class="btn-clear" id="clearBtn" style="display:none;" onclick="clearSearch()">âœ• Clear</button>
    </div>

    <!-- Table -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Ref ID</th><th>Team Name</th><th>College</th>
            <th>Size</th><th>Members</th><th>Medical Notes</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="6" class="loading">Loading registrationsâ€¦</td></tr>
        </tbody>
      </table>
    </div>
    <div class="count-info" id="countInfo"></div>
  </div>

  <script>
    const token = sessionStorage.getItem('admin_token');
    if (!token) window.location.href = 'admin-login.html';

    let currentSearch = '';

    async function loadData(q = '') {
      const url = q ? `/api/admin-data?q=${encodeURIComponent(q)}` : '/api/admin-data';
      try {
        const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
        if (res.status === 401) { logout(); return; }
        const data = await res.json();
        if (data.error) { alert('Error: ' + data.error); return; }

        // Stats
        document.getElementById('statTeams').textContent = data.stats.total_teams;
        document.getElementById('statMembers').textContent = data.stats.total_members;
        document.getElementById('statVeg').textContent = data.stats.veg;
        document.getElementById('statNonveg').textContent = data.stats.nonveg;

        // Table
        const tbody = document.getElementById('tableBody');
        if (!data.rows.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="no-results">${q ? `No results for "${q}"` : 'No registrations yet.'}</td></tr>`;
          document.getElementById('countInfo').textContent = '';
          return;
        }

        tbody.innerHTML = data.rows.map(row => {
          const members = [];
          for (let i = 1; i <= 4; i++) {
            if (row[`p${i}`]) {
              const food = row[`p${i}_food`] || '';
              const isVeg = food === 'Vegetarian';
              const icon = isVeg ? 'ðŸ¥¦' : 'ðŸ—';
              const cls = isVeg ? 'food-veg' : 'food-nonveg';
              members.push(`<span class="member-chip">${esc(row[`p${i}`])} <span class="${cls}">${icon}</span></span>`);
            }
          }
          return `<tr>
            <td><span class="ref-badge">${esc(row.ref_id || 'N/A')}</span></td>
            <td class="team-name">${esc(row.team)}</td>
            <td>${esc(row.college)}</td>
            <td style="text-align:center;font-weight:700;">${row.team_size}</td>
            <td>${members.join('<br>')}</td>
            <td style="font-size:12px;color:rgba(255,255,255,.5);max-width:180px;">${row.medical ? esc(row.medical) : '<span style="opacity:.3">â€”</span>'}</td>
          </tr>`;
        }).join('');

        const c = data.rows.length;
        document.getElementById('countInfo').textContent = `Showing ${c} registration${c !== 1 ? 's' : ''}${q ? ` for "${q}"` : ''}`;
      } catch (err) {
        document.getElementById('tableBody').innerHTML = '<tr><td colspan="6" class="no-results">Failed to load data. Please refresh.</td></tr>';
      }
    }

    function esc(str) {
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function doSearch() {
      const q = document.getElementById('searchInput').value.trim();
      currentSearch = q;
      document.getElementById('clearBtn').style.display = q ? 'block' : 'none';
      loadData(q);
    }

    function clearSearch() {
      document.getElementById('searchInput').value = '';
      document.getElementById('clearBtn').style.display = 'none';
      currentSearch = '';
      loadData();
    }

    async function doExport(type) {
      const url = `/api/export-${type}`;
      try {
        const res = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
        if (res.status === 401) { logout(); return; }
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        const now = new Date().toISOString().replace(/[:.]/g,'-').slice(0,19);
        const ext = { csv: 'csv', xlsx: 'xlsx', docx: 'docx' }[type];
        a.download = `techblaze3_${now}.${ext}`;
        a.click();
        URL.revokeObjectURL(a.href);
      } catch {
        alert('Export failed. Please try again.');
      }
    }

    function logout() {
      sessionStorage.removeItem('admin_token');
      window.location.href = 'admin-login.html';
    }

    // Initial load
    loadData();
  </script>
</body>
</html>
